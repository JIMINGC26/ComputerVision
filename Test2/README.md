# *ç»ƒä¹ äºŒ: Tensorflow Playground & LeNet-5*

## ç›®å½•
> ä¸€ ä½¿ç”¨Tensorflow Playground  
> äºŒ LeNet-5  
>   1. ç½‘ç»œç»“æ„  
>   2. MNISTæ•°æ®é›†  
>   3. è®­ç»ƒ  
>   4. ä»£ç   
>   5. å®éªŒç»“æœåŠå…¶åˆ†æ

## **ä¸€ è¯•ç”¨Tensorflow Playground**

**Tensorflow Playground**åˆåTensorFlowæ¸¸ä¹åœºï¼Œæ˜¯ä¸€ä¸ªç”¨æ¥å›¾å½¢åŒ–æ•™å­¦çš„ç®€å•ç¥ç»ç½‘ç»œåœ¨çº¿æ¼”ç¤ºå’Œå®éªŒçš„å¹³å°ï¼Œéå¸¸å¼ºå¤§ä¸”æå…¶æ˜“ç”¨ï¼Œåœ¨è¿™ä¸ªè¶…çº§æ˜“æ‡‚çš„ demo é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿä½“éªŒä¸€ä¸ªç®—æ³•å·¥ç¨‹å¸ˆçš„è°ƒå‚å·¥ä½œã€‚
å¯¹Tensorflow Playgroundè¿›è¡Œä¸€ä¸ªç»†è‡´çš„å¸ƒå±€åˆ’åˆ†ï¼Œæ€»ä½“ä¸Šæœ‰å¦‚ä¸‹åŒºåŸŸï¼š  
> - è¿è¡Œæ§åˆ¶åŒºï¼Œè¿™é‡Œä¸»è¦å¯¹ç®—æ³•æ‰§è¡Œè¿›è¡Œæ§åˆ¶ï¼Œå¯ä»¥å¯åŠ¨ã€æš‚åœå’Œé‡ç½®
> - è¿­ä»£æ¬¡æ•°å±•ç¤ºåŒºï¼Œè¿™é‡Œå±•ç¤ºå½“å‰ç®—æ³•æ‰§è¡Œåˆ°äº†å“ªä¸€æ¬¡è¿­ä»£
> - è¶…å‚æ•°é€‰æ‹©åŒºï¼Œè¿™é‡Œå¯ä»¥è°ƒæ•´ç®—æ³•çš„ä¸€äº›è¶…å‚æ•°ï¼Œä¸åŒçš„è¶…å‚èƒ½è§£å†³ä¸åŒçš„ç®—æ³•é—®é¢˜ï¼Œå¾—åˆ°ä¸åŒçš„æ•ˆæœ
> - æ•°æ®é›†è°ƒæ•´åŒºï¼Œæ•°æ®é›†å®šä¹‰äº†æˆ‘ä»¬è¦è§£å†³æ€æ ·çš„é—®é¢˜ï¼Œæ•°æ®é›†æ˜¯æœºå™¨å­¦ä¹ æœ€ä¸ºé‡è¦çš„ä¸€ç¯
> - ç‰¹å¾å‘é‡é€‰æ‹©ï¼Œä»æ•°æ®é›†ä¸­æ”«å–å‡ºçš„å¯ä»¥ç”¨æ¥è¢«è®­ç»ƒçš„ç‰¹å¾å€¼
> - ç¥ç»ç½‘ç»œåŒºåŸŸï¼Œç®—æ³•å·¥ç¨‹å¸ˆæ„å»ºçš„ç”¨äºæ•°æ®æ‹Ÿåˆçš„ç½‘ç»œ
> - é¢„æµ‹ç»“æœåŒºï¼Œå±•ç¤ºæ­¤ç®—æ³•çš„é¢„æµ‹ç»“æœ  

![åŒºåŸŸç¤ºæ„å›¾](image/Tensorflow.png)

> Tensorflow Playgroundæä¾›äº†å››ç§ä¸åŒçš„æ•°æ®é›†ï¼Œé€šè¿‡è°ƒå‚å¯ä»¥å¯¹æ•°æ®é›†è¿›è¡Œæ‹Ÿåˆã€‚é€šè¿‡è°ƒè¯•ï¼Œå¾—åˆ°å¯¹å››ä¸ªæ•°æ®é›†çš„æ‹Ÿåˆç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  

![Dataset1](image/1.png)
![Dataset2](image/2.png)
![Dataset3](image/3.png)
![Dataset4](image/4.png)


## **LeNet-5**
### 1 LeNet-5ç½‘ç»œç»“æ„
**Lenet-5**æ˜¯ä¸€ç§ç»å…¸çš„å·ç§¯ç¥ç»ç½‘ç»œï¼Œç”±Yann LeCunç­‰äººäº1998å¹´æå‡ºï¼Œæ˜¯æ·±åº¦å­¦ä¹ çš„å…ˆé©±ä¹‹ä¸€ã€‚å®ƒä¸»è¦ç”¨äºæ‰‹å†™æ•°å­—è¯†åˆ«çš„ä»»åŠ¡ï¼Œä½†ä¹Ÿè¢«å¹¿æ³›åº”ç”¨äºå…¶ä»–å›¾åƒåˆ†ç±»ä»»åŠ¡ã€‚
Lenet-5ç½‘ç»œç»“æ„åŒ…å«7å±‚ï¼Œåˆ†åˆ«æ˜¯ï¼š
> 1. è¾“å…¥å±‚ï¼ˆInput Layerï¼‰ï¼š28Ã—28çš„ç°åº¦å›¾åƒã€‚
> 2. å·ç§¯å±‚1ï¼ˆConvolutional Layer 1ï¼‰ï¼š6ä¸ªå·ç§¯æ ¸ï¼Œå¤§å°ä¸º5Ã—5ï¼Œæ­¥é•¿ä¸º1ï¼Œæ— å¡«å……ï¼ˆpaddingï¼‰ï¼Œæ¿€æ´»å‡½æ•°ä½¿ç”¨Sigmoidå‡½æ•°ã€‚
> 3. æ± åŒ–å±‚1ï¼ˆPooling Layer 1ï¼‰ï¼š2Ã—2æœ€å¤§æ± åŒ–ï¼Œæ­¥é•¿ä¸º2ã€‚
> 4. å·ç§¯å±‚2ï¼ˆConvolutional Layer 2ï¼‰ï¼š16ä¸ªå·ç§¯æ ¸ï¼Œå¤§å°ä¸º5Ã—5ï¼Œæ­¥é•¿ä¸º1ï¼Œæ— å¡«å……ï¼Œæ¿€æ´»å‡½æ•°ä½¿ç”¨Sigmoidå‡½æ•°ã€‚
> 5. æ± åŒ–å±‚2ï¼ˆPooling Layer 2ï¼‰ï¼š2Ã—2æœ€å¤§æ± åŒ–ï¼Œæ­¥é•¿ä¸º2ã€‚
> 6. å…¨è¿æ¥å±‚1ï¼ˆFully Connected Layer 1ï¼‰ï¼š120ä¸ªç¥ç»å…ƒï¼Œæ¿€æ´»å‡½æ•°ä½¿ç”¨Sigmoidå‡½æ•°ã€‚
> 7. å…¨è¿æ¥å±‚2ï¼ˆFully Connected Layer 2ï¼‰ï¼š84ä¸ªç¥ç»å…ƒï¼Œæ¿€æ´»å‡½æ•°ä½¿ç”¨Sigmoidå‡½æ•°ã€‚
> 8. è¾“å‡ºå±‚ï¼ˆOutput Layerï¼‰ï¼š10ä¸ªç¥ç»å…ƒï¼Œä»£è¡¨æ•°å­—0~9çš„åˆ†ç±»ç»“æœï¼Œæ¿€æ´»å‡½æ•°ä½¿ç”¨Softmaxå‡½æ•°ã€‚  
### 2 MNISTæ•°æ®é›†
**MNISTæ•°æ®é›†**æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ‰‹å†™æ•°å­—è¯†åˆ«æ•°æ®é›†ï¼Œæ˜¯æ·±åº¦å­¦ä¹ é¢†åŸŸæœ€ç»å…¸çš„æ•°æ®é›†ä¹‹ä¸€ï¼Œç”±Yann LeCunç­‰äººæ”¶é›†æ•´ç†ã€‚è¯¥æ•°æ®é›†åŒ…å«60000å¼ è®­ç»ƒå›¾åƒå’Œ10000å¼ æµ‹è¯•å›¾åƒï¼Œæ¯å¼ å›¾åƒéƒ½æ˜¯28x28åƒç´ å¤§å°çš„ç°åº¦å›¾åƒï¼Œæ ‡è®°ä¸º0~9ä¸­çš„ä¸€ä¸ªæ•°å­—ã€‚  
**MNISTæ•°æ®é›†**çš„ç›®çš„æ˜¯ç”¨äºæœºå™¨å­¦ä¹ ç®—æ³•çš„æ€§èƒ½æµ‹è¯•å’Œæ¯”è¾ƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯è®¸å¤šæ·±åº¦å­¦ä¹ ç®—æ³•çš„åŸºå‡†æ•°æ®é›†ä¹‹ä¸€ã€‚å®ƒè¢«å¹¿æ³›ç”¨äºå›¾åƒè¯†åˆ«ã€å­—ç¬¦è¯†åˆ«ã€æ‰‹å†™æ–‡å­—è¯†åˆ«ç­‰é¢†åŸŸçš„ç ”ç©¶å’Œåº”ç”¨ã€‚
### 3 è®­ç»ƒ
æœ¬æ¬¡å®éªŒä¸­è§£å†³çš„æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜å› æ­¤é€‰æ‹©**äº¤å‰ç†µï¼ˆCrossEntropyï¼‰**ä½œä¸ºæŸå¤±å‡½æ•°ï¼Œå…¶å…¬å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![CrossEntropy](image/CrossEntropy.png#pic_center)  
å…¶ä¸­ğ‘€è¡¨ç¤ºç±»åˆ«çš„æ•°é‡ï¼Œğ‘¦ğ‘–ğ‘æ˜¯ç¬¦å·å‡½æ•°ï¼Œå¦‚æœåˆ†ç±»æ­£ç¡®å– 1ï¼Œé”™è¯¯å– 0ï¼Œğ‘ğ‘–ğ‘æ˜¯è§‚æµ‹æ ·æœ¬å±äºå¯¹åº”ç±»åˆ«çš„é¢„æµ‹æ¦‚ç‡ã€‚åœ¨ç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯¹æŸå¤±å‡½æ•°è¿›è¡Œæ¢¯åº¦ä¸‹é™è¿›è¡Œä¼˜åŒ–ï¼Œè®­ç»ƒç½‘ç»œä¸­çš„æƒå€¼ã€‚  
**æœ¬æ¬¡å®éªŒé€‰æ‹©SGDï¼ˆéšæœºæ¢¯åº¦ä¸‹é™ï¼‰ä½œä¸ºè®­ç»ƒçš„ä¼˜åŒ–å™¨**ï¼Œå…¶ä¸»è¦æ€æƒ³æ˜¯åœ¨æ¯æ¬¡æ›´æ–°æ¨¡å‹å‚æ•°æ—¶ï¼Œä½¿ç”¨éšæœºé€‰æ‹©çš„ä¸€å°æ‰¹è®­ç»ƒæ ·æœ¬æ¥è®¡ç®—æ¢¯åº¦ï¼Œä»è€ŒåŠ é€Ÿæ¨¡å‹è®­ç»ƒã€‚  
å…·ä½“æ¥è¯´ï¼ŒSGDç®—æ³•åœ¨æ¯æ¬¡è¿­ä»£ä¸­ä»è®­ç»ƒé›†ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå°æ‰¹é‡çš„æ ·æœ¬è¿›è¡Œè®¡ç®—ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªå°æ‰¹é‡æ ·æœ¬è®¡ç®—æŸå¤±å‡½æ•°å¯¹æ¨¡å‹å‚æ•°çš„åå¯¼æ•°ï¼Œå³æ¢¯åº¦ã€‚ç„¶åï¼Œä½¿ç”¨è¿™ä¸ªæ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹çš„å‚æ•°ï¼Œä»¥ä½¿æŸå¤±å‡½æ•°æœ€å°åŒ–ã€‚è¿™ä¸ªè¿‡ç¨‹é‡å¤å¤šæ¬¡ï¼Œç›´åˆ°è¾¾åˆ°é¢„å®šçš„åœæ­¢æ¡ä»¶ï¼ˆå¦‚è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ã€æŸå¤±å‡½æ•°å˜åŒ–å°äºæŸä¸ªé˜ˆå€¼ç­‰ï¼‰ä¸ºæ­¢ã€‚  
ä¸æ‰¹é‡æ¢¯åº¦ä¸‹é™ï¼ˆBatch Gradient Descentï¼‰ç›¸æ¯”ï¼ŒSGDçš„ä¸»è¦ä¼˜ç‚¹æ˜¯è®¡ç®—æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºå®ƒæ¯æ¬¡åªè®¡ç®—ä¸€å°æ‰¹æ ·æœ¬çš„æ¢¯åº¦ï¼Œè€Œä¸æ˜¯è®¡ç®—å…¨éƒ¨æ ·æœ¬çš„æ¢¯åº¦ã€‚å¦å¤–ï¼ŒSGDåœ¨é‡åˆ°å¤§è§„æ¨¡æ•°æ®é›†æ—¶ï¼Œé€šå¸¸æ¯”æ‰¹é‡æ¢¯åº¦ä¸‹é™æ›´å®¹æ˜“æ”¶æ•›åˆ°å±€éƒ¨æœ€ä¼˜è§£ã€‚ä½†æ˜¯ï¼Œç”±äºéšæœºé€‰æ‹©çš„å°æ‰¹é‡æ ·æœ¬å…·æœ‰ä¸€å®šçš„å™ªå£°ï¼Œå› æ­¤SGDçš„æ”¶æ•›è¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒä¸ç¨³å®šï¼Œéœ€è¦ç»è¿‡ä¸€å®šçš„è°ƒå‚æ¥ä¼˜åŒ–ç®—æ³•çš„æ€§èƒ½ã€‚
### 4 ä»£ç 
å®šä¹‰Lenet-5ç½‘ç»œæ¨¡å‹åŠforwardå‡½æ•°ä»£ç ï¼š  
~~~
class Model(Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1,6, 5)
        self.relu1 = nn.ReLU()
        self.pool1 = nn.MaxPool2d(2)
        self.conv2 = nn.Conv2d(6, 16, 5)
        self.relu2 = nn.ReLU()
        self.pool2 = nn.MaxPool2d(2)
        self.fc1 = nn.Linear(256, 120)
        self.relu3 = nn.ReLU()
        self.fc2 = nn.Linear(120, 84)
        self.relu4 = nn.ReLU()
        self.fc3 = nn.Linear(84, 10)
        self.relu5 = nn.ReLU()

    def forward(self, x):
        y = self.conv1(x)
        y = self.relu1(y)
        y = self.pool1(y)
        y = self.conv2(y)
        y = self.relu2(y)
        y = self.pool2(y)
        y = y.view(y.shape[0], -1)
        y = self.fc1(y)
        y = self.relu3(y)
        y = self.fc2(y)
        y = self.relu4(y)
        y = self.fc3(y)
        y = self.relu5(y)
        return y
~~~
ä½¿ç”¨Dataloaderè¯»å–æ•°æ®é›†ï¼Œå¹¶å®šä¹‰è®­ç»ƒå™¨ï¼š
~~~
    train_dataset = mnist.MNIST(root='D:\pythonProject\ComputerVision\Test2\\train', train=True, download=True, transform=ToTensor())
    test_dataset = mnist.MNIST(root='D:\pythonProject\ComputerVision\Test2\\test', train=False, download=True, transform=ToTensor())
    train_loader = DataLoader(train_dataset, batch_size=batch_size)
    test_loader = DataLoader(test_dataset, batch_size=batch_size)
    model = Model().to(device)
    sgd = SGD(model.parameters(), lr=1e-1)
    loss_fn = CrossEntropyLoss()
    all_epoch = 100
    prev_acc = 0
~~~
è¿­ä»£è®­ç»ƒï¼š
~~~
    for current_epoch in range(all_epoch):
        model.train()
        for idx, (train_x, train_label) in enumerate(train_loader):
            train_x = train_x.to(device)
            train_label = train_label.to(device)
            sgd.zero_grad()
            predict_y = model(train_x.float())
            loss = loss_fn(predict_y, train_label.long())
            loss.backward()
            sgd.step()
        
        
        all_correct_num = 0
        all_sample_num = 0
        model.eval()
~~~
æµ‹è¯•æ¨¡å‹ï¼š
~~~
        for idx, (test_x, test_label) in enumerate(test_loader):
            test_x = test_x.to(device)
            test_label = test_label.to(device)
            predict_y = model(test_x.float()).detach()
            predict_y =torch.argmax(predict_y, dim=-1)
            current_correct_num = predict_y == test_label
            all_correct_num += np.sum(current_correct_num.to('cpu').numpy(), axis=-1)
            all_sample_num += current_correct_num.shape[0]
~~~
æ‰“å°losså¹¶å°†è®­ç»ƒç»“æœä¿å­˜åœ¨experimentsæ–‡ä»¶å¤¹ä¸‹ï¼š
~~~
        acc = all_correct_num / all_sample_num
        print('accuracy: {:.3f}'.format(acc), flush=True)
        # ä¿®æ”¹ä¸ºä¿å­˜å®éªŒçš„æ–‡ä»¶å¤¹è·¯å¾„
        if not os.path.isdir("experiments"):
            os.mkdir("experiments")
        torch.save(model, 'experiments/lenet_mnist_{:.3f}.pkl'.format(acc))
        if np.abs(acc - prev_acc) < 1e-4:
            break
        prev_acc = acc
    print("Model finished training")
~~~
### 5 å®éªŒç»“æœåŠåˆ†æ
**å®éªŒç»“æœ**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![result](image/result.png)  

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨MNISTæ•°æ®é›†ä¸Šç»è¿‡åè½®è®­ç»ƒåï¼ŒLenet-5ç½‘ç»œå¯ä»¥è¾¾åˆ°0.982çš„å‡†ç¡®åº¦ï¼Œè¯´æ˜è¯¥æ¨¡å‹åœ¨æ‰‹å†™æ•°å­—è¯†åˆ«è¿™ä¸€ä»»åŠ¡ä¸Šèƒ½å¾—åˆ°å‡ºè‰²çš„æ•ˆæœã€‚




